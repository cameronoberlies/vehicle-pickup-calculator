<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Pickup Travel Cost Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 500px;
            width: 100%;
        }
        
        h1 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #718096;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            color: #4a5568;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }
        
        .result {
            margin-top: 30px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            display: none;
        }
        
        .result.show {
            display: block;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .result-label {
            color: #718096;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }
        
        .result-value {
            color: #2d3748;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 15px;
        }
        
        .result-details {
            color: #4a5568;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .error {
            margin-top: 20px;
            padding: 15px;
            background: #fed7d7;
            border-radius: 8px;
            color: #c53030;
            font-size: 14px;
            display: none;
        }
        
        .error.show {
            display: block;
        }
        
        .loading {
            display: none;
            margin-top: 15px;
            text-align: center;
            color: #667eea;
            font-size: 14px;
        }
        
        .loading.show {
            display: block;
        }
        
        .destination {
            background: #edf2f7;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #4a5568;
        }
        
        .destination strong {
            color: #2d3748;
        }
        
        .autocomplete-container {
            position: relative;
        }
        
        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e2e8f0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .autocomplete-suggestions.show {
            display: block;
        }
        
        .suggestion-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f7fafc;
            transition: background-color 0.2s;
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-item:hover,
        .suggestion-item.active {
            background-color: #edf2f7;
        }
        
        .suggestion-item .suggestion-name {
            color: #2d3748;
            font-weight: 500;
            font-size: 14px;
        }
        
        .suggestion-item .suggestion-details {
            color: #718096;
            font-size: 12px;
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Vehicle Pickup Calculator</h1>
        <p class="subtitle">Calculate travel costs for vehicle pickup</p>
        
        <div class="destination">
            <strong>Destination:</strong> Shelby, NC | <strong>Rate:</strong> $2.00/mile
        </div>
        
        <div class="input-group">
            <label for="location">Vehicle Location</label>
            <div class="autocomplete-container">
                <input 
                    type="text" 
                    id="location" 
                    placeholder="Enter city, state or full address"
                    autocomplete="off"
                >
                <div class="autocomplete-suggestions" id="suggestions"></div>
            </div>
        </div>
        
        <button id="calculateBtn">Calculate Travel Cost</button>
        
        <div class="loading" id="loading">Calculating route...</div>
        
        <div class="result" id="result">
            <div class="result-label">Total Travel Cost</div>
            <div class="result-value" id="cost">$0.00</div>
            <div class="result-details">
                <strong>Distance:</strong> <span id="distance">0</span> miles<br>
                <strong>From:</strong> <span id="from">-</span><br>
                <strong>To:</strong> Shelby, NC
            </div>
        </div>
        
        <div class="error" id="error"></div>
    </div>

    <script>
        const RATE_PER_MILE = 2.00;
        const DESTINATION = 'Shelby, NC';
        
        // Shelby, NC coordinates
        const DEST_LAT = 35.2923;
        const DEST_LON = -81.5357;
        
        const locationInput = document.getElementById('location');
        const calculateBtn = document.getElementById('calculateBtn');
        const resultDiv = document.getElementById('result');
        const errorDiv = document.getElementById('error');
        const loadingDiv = document.getElementById('loading');
        const costSpan = document.getElementById('cost');
        const distanceSpan = document.getElementById('distance');
        const fromSpan = document.getElementById('from');
        const suggestionsDiv = document.getElementById('suggestions');
        
        let debounceTimer;
        let selectedSuggestionIndex = -1;
        let suggestions = [];
        let selectedCoords = null; // Store coords from selected suggestion
        let currentSearchQuery = ''; // Track current search to prevent race conditions
        let abortController = null; // For canceling in-flight requests
        
        // Autocomplete as user types
        locationInput.addEventListener('input', (e) => {
            const query = e.target.value.trim();
            
            // Clear stored coords when user manually types
            selectedCoords = null;
            
            clearTimeout(debounceTimer);
            
            // Cancel any pending requests
            if (abortController) {
                abortController.abort();
            }
            
            if (query.length < 2) {
                hideSuggestions();
                currentSearchQuery = '';
                return;
            }
            
            // Longer debounce for smoother experience (400ms instead of 300ms)
            debounceTimer = setTimeout(() => {
                fetchSuggestions(query);
            }, 400);
        });
        
        // Keyboard navigation for suggestions
        locationInput.addEventListener('keydown', (e) => {
            const suggestionItems = suggestionsDiv.querySelectorAll('.suggestion-item');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, suggestionItems.length - 1);
                updateActiveSuggestion(suggestionItems);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                updateActiveSuggestion(suggestionItems);
            } else if (e.key === 'Enter') {
                if (selectedSuggestionIndex >= 0 && suggestionItems.length > 0) {
                    e.preventDefault();
                    selectSuggestion(suggestions[selectedSuggestionIndex]);
                }
            } else if (e.key === 'Escape') {
                hideSuggestions();
            }
        });
        
        // Close suggestions when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.autocomplete-container')) {
                hideSuggestions();
            }
        });
        
        async function fetchSuggestions(query) {
            // Prevent race conditions - ignore stale requests
            currentSearchQuery = query;
            
            try {
                // Create new abort controller for this request
                abortController = new AbortController();
                
                // Prioritize cities and states by using structured query
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=us&limit=8&addressdetails=1`;
                
                const response = await fetch(url, {
                    headers: {
                        'User-Agent': 'VehiclePickupCalculator/1.0'
                    },
                    signal: abortController.signal
                });
                
                if (!response.ok) return;
                
                const data = await response.json();
                
                // Only update if this is still the current search
                if (query !== currentSearchQuery) {
                    return;
                }
                
                // Filter and rank results for better quality
                const rankedResults = rankResults(data, query);
                
                suggestions = rankedResults;
                displaySuggestions(rankedResults);
                
            } catch (error) {
                // Ignore abort errors (expected when user keeps typing)
                if (error.name === 'AbortError') {
                    return;
                }
                console.error('Failed to fetch suggestions:', error);
            }
        }
        
        function rankResults(results, query) {
            const queryLower = query.toLowerCase();
            
            // Score and sort results
            const scored = results.map(item => {
                let score = 0;
                const address = item.address || {};
                const displayLower = item.display_name.toLowerCase();
                
                // Prioritize cities, towns, and states
                if (address.city || address.town || address.village) score += 100;
                if (address.state) score += 50;
                
                // Boost exact matches at the start
                if (displayLower.startsWith(queryLower)) score += 200;
                
                // Boost if query matches city/town name
                const cityName = (address.city || address.town || address.village || '').toLowerCase();
                if (cityName.startsWith(queryLower)) score += 150;
                
                // Penalize very long addresses (likely specific buildings)
                if (item.display_name.length > 100) score -= 30;
                
                // Prioritize place types
                const goodTypes = ['city', 'town', 'village', 'state', 'county'];
                if (goodTypes.includes(item.type)) score += 80;
                
                return { ...item, score };
            });
            
            // Sort by score (highest first) and return top results
            return scored
                .sort((a, b) => b.score - a.score)
                .slice(0, 5);
        }
        
        function displaySuggestions(data) {
            if (data.length === 0) {
                hideSuggestions();
                return;
            }
            
            suggestionsDiv.innerHTML = data.map((item, index) => {
                // Format the display name more cleanly
                const address = item.address || {};
                let primaryText = '';
                let secondaryText = '';
                
                // Build cleaner display
                if (address.city || address.town || address.village) {
                    primaryText = address.city || address.town || address.village;
                    secondaryText = address.state || '';
                } else if (address.county) {
                    primaryText = address.county;
                    secondaryText = address.state || '';
                } else {
                    // Fallback to display_name but trim it
                    const parts = item.display_name.split(',').slice(0, 3);
                    primaryText = parts[0];
                    secondaryText = parts.slice(1).join(',');
                }
                
                return `
                    <div class="suggestion-item" data-index="${index}">
                        <div class="suggestion-name">${primaryText}</div>
                        ${secondaryText ? `<div class="suggestion-details">${secondaryText}</div>` : ''}
                    </div>
                `;
            }).join('');
            
            // Add click handlers
            suggestionsDiv.querySelectorAll('.suggestion-item').forEach((item, index) => {
                item.addEventListener('click', () => {
                    selectSuggestion(suggestions[index]);
                });
            });
            
            showSuggestions();
            selectedSuggestionIndex = -1;
        }
        
        function selectSuggestion(suggestion) {
            locationInput.value = suggestion.display_name;
            // Store the coordinates from the selected suggestion
            selectedCoords = {
                lat: parseFloat(suggestion.lat),
                lon: parseFloat(suggestion.lon)
            };
            hideSuggestions();
            // Auto-trigger calculation after selection
            setTimeout(() => calculateBtn.click(), 100);
        }
        
        function updateActiveSuggestion(items) {
            items.forEach((item, index) => {
                if (index === selectedSuggestionIndex) {
                    item.classList.add('active');
                    item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                } else {
                    item.classList.remove('active');
                }
            });
        }
        
        function showSuggestions() {
            suggestionsDiv.classList.add('show');
        }
        
        function hideSuggestions() {
            suggestionsDiv.classList.remove('show');
            selectedSuggestionIndex = -1;
        }
        
        // Allow Enter key to trigger calculation
        locationInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                calculateBtn.click();
            }
        });
        
        calculateBtn.addEventListener('click', async () => {
            const location = locationInput.value.trim();
            
            if (!location) {
                showError('Please enter a vehicle location');
                return;
            }
            
            hideError();
            hideResult();
            showLoading();
            disableButton();
            
            try {
                // Step 1: Get coordinates (use stored coords if available from suggestion)
                const originCoords = selectedCoords || await geocodeLocation(location);
                
                // Step 2: Get driving distance
                const distance = await getDrivingDistance(originCoords);
                
                // Step 3: Calculate cost
                const cost = distance * RATE_PER_MILE;
                
                // Display results
                showResult(location, distance, cost);
                
            } catch (error) {
                showError(error.message);
            } finally {
                hideLoading();
                enableButton();
            }
        });
        
        async function geocodeLocation(location) {
            // Using Nominatim (OpenStreetMap) for geocoding
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}, USA&limit=1`;
            
            const response = await fetch(url, {
                headers: {
                    'User-Agent': 'VehiclePickupCalculator/1.0'
                }
            });
            
            if (!response.ok) {
                throw new Error('Failed to find location. Please try again.');
            }
            
            const data = await response.json();
            
            if (data.length === 0) {
                throw new Error('Location not found. Please check the address and try again.');
            }
            
            return {
                lat: parseFloat(data[0].lat),
                lon: parseFloat(data[0].lon)
            };
        }
        
        async function getDrivingDistance(origin) {
            // Using OSRM (Open Source Routing Machine) - no API key needed and CORS-friendly
            const url = `https://router.project-osrm.org/route/v1/driving/${origin.lon},${origin.lat};${DEST_LON},${DEST_LAT}?overview=false`;
            
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error('Failed to calculate route. Please try again.');
            }
            
            const data = await response.json();
            
            if (data.code !== 'Ok' || !data.routes || data.routes.length === 0) {
                throw new Error('Could not find a route to this location.');
            }
            
            // Distance is in meters, convert to miles
            //Test
            const distanceMeters = data.routes[0].distance;
            const distanceMiles = distanceMeters * 0.000621371;
            
            // Apply adjustment factor to match Google Maps more closely
            // OSRM tends to be about 3% shorter than Google Maps
            const adjustedMiles = distanceMiles * 1.03;
            
            return Math.round(adjustedMiles);
        }
        
        function showResult(from, distance, cost) {
            fromSpan.textContent = from;
            distanceSpan.textContent = distance.toLocaleString();
            costSpan.textContent = `$${Math.round(cost)}`;
            resultDiv.classList.add('show');
        }
        
        function hideResult() {
            resultDiv.classList.remove('show');
        }
        
        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }
        
        function hideError() {
            errorDiv.classList.remove('show');
        }
        
        function showLoading() {
            loadingDiv.classList.add('show');
        }
        
        function hideLoading() {
            loadingDiv.classList.remove('show');
        }
        
        function disableButton() {
            calculateBtn.disabled = true;
            calculateBtn.textContent = 'Calculating...';
        }
        
        function enableButton() {
            calculateBtn.disabled = false;
            calculateBtn.textContent = 'Calculate Travel Cost';
        }
    </script>
</body>
</html>


